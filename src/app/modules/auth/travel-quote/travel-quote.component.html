<div class="min-h-screen w-screen bg-gray-50">
    <!-- Header -->
    <header class="sticky top-0 z-10 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-6">
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center gap-4">
                    <img
                        src="https://media.licdn.com/dms/image/v2/C4D0BAQGK4ya3Y0V4Iw/company-logo_200_200/company-logo_200_200/0/1631336758836?e=2147483647&v=beta&t=qRDfOKgxDnq46pE6Pv8nqRhBsJE-Qsz2AIfP0NssBzY"
                        alt="Fidelity Logo"
                        class="h-10 w-auto rounded-lg" />
                    <h1 class="text-xl font-semibold text-slate-800">
                        Fidelity Travel Insurance
                    </h1>
                </div>
                <button (click)="closeForm()" class="flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50" title="Close">
                    <mat-icon class="!h-4 !w-4 !text-base">close</mat-icon>Close
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="p-6">
        <div class="mx-auto max-w-7xl">
            <!-- Progress Steps -->
            <div class="mb-8">
                 <div class="flex items-center">
                    <div class="flex items-center" [class.text-fidelity-turquoise]="currentStep >= 1" [class.text-gray-500]="currentStep < 1">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-turquoise]="currentStep >= 1" [class.text-white]="currentStep >= 1" [class.bg-gray-300]="currentStep < 1">1</div>
                        <span class="ml-2 text-sm font-medium">Quote & Select Plan</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-fidelity-turquoise]="currentStep > 1" [class.bg-gray-300]="currentStep <= 1"></div>
                    <div class="flex items-center" [class.text-fidelity-turquoise]="currentStep >= 2" [class.text-gray-500]="currentStep < 2">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-turquoise]="currentStep >= 2" [class.text-white]="currentStep >= 2" [class.bg-gray-300]="currentStep < 2">2</div>
                        <span class="ml-2 text-sm font-medium">Traveler Details</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-fidelity-turquoise]="currentStep > 2" [class.bg-gray-300]="currentStep <= 2"></div>
                    <div class="flex items-center" [class.text-fidelity-turquoise]="currentStep >= 3" [class.text-gray-500]="currentStep < 3">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-fidelity-turquoise]="currentStep >= 3" [class.text-white]="currentStep >= 3" [class.bg-gray-300]="currentStep < 3">3</div>
                        <span class="ml-2 text-sm font-medium">Review & Pay</span>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                <!-- Left Column: Forms -->
                <div [ngClass]="{'lg:col-span-3': currentStep === 1, 'lg:col-span-2': currentStep > 1}">
                    <!-- Step 1: Quote Form & Plan Selection -->
                    <div *ngIf="currentStep === 1" class="step-content">
                        <form [formGroup]="quoteForm">
                            <div class="rounded-lg bg-white p-6 shadow-sm">
                                <h2 class="mb-2 text-2xl font-semibold text-gray-900">Get Your Travel Insurance Quote</h2>
                                <p class="mb-6 text-gray-600">Tell us about your trip to see available plans and pricing.</p>
                                <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Policy Type<span class="text-red-500">*</span></label>
                                        <select formControlName="policyType" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2">
                                            <option value="standard">Standard Travel</option>
                                            <option value="student">Student Travel</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Cover Period<span class="text-red-500">*</span></label>
                                        <select formControlName="duration" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2">
                                            <option value="" disabled>Select duration</option>
                                            <ng-container *ngIf="qf.policyType.value === 'standard'">
                                                <option *ngFor="let d of standardDurations" [value]="d.value">{{ d.label }}</option>
                                            </ng-container>
                                            <ng-container *ngIf="qf.policyType.value === 'student'">
                                                <option *ngFor="let d of studentDurations" [value]="d.value">{{ d.label }}</option>
                                            </ng-container>
                                        </select>
                                    </div>
                                </div>
                            </div>
    
                            <div *ngIf="qf.duration.value" class="mt-8">
                                <h3 class="mb-4 text-xl font-semibold text-gray-800">Select a Plan</h3>
                                <!-- RESPONSIVE GRID LAYOUT -->
                                <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-5">
                                    <div *ngFor="let plan of displayedPlans" class="plan-card" [ngClass]="{'selected-plan': qf.plan.value === plan.id}">
                                        <div *ngIf="plan.isMostPopular" class="most-popular-badge">Most Popular</div>
                                        <div class="plan-header">
                                            <mat-icon class="plan-icon">public</mat-icon>
                                            <h4 class="plan-name">{{ plan.name }}</h4>
                                            <p class="plan-description">{{ plan.description }}</p>
                                        </div>
                                        <div class="plan-price">
                                            <span class="price-amount">${{ plan.priceUSD | number:'1.0-0' }}</span>
                                            <div class="price-period">per trip</div>
                                        </div>
                                        <div class="plan-tags">
                                            <span *ngFor="let tag of plan.tags" class="plan-tag">{{ tag }}</span>
                                        </div>
                                        <ul class="plan-benefits">
                                            <li *ngFor="let benefit of plan.benefits" class="benefit-item">
                                                <mat-icon class="benefit-icon" [ngClass]="{'included': benefit.included, 'not-included': !benefit.included}">
                                                    {{ benefit.included ? 'check_circle' : 'radio_button_unchecked' }}
                                                </mat-icon>
                                                <div class="benefit-text">
                                                    <div class="benefit-name">{{ benefit.name }}</div>
                                                    <div *ngIf="benefit.limit" class="benefit-limit">{{ benefit.limit }}</div>
                                                    <div *ngIf="benefit.notes" class="benefit-notes">{{ benefit.notes }}</div>
                                                </div>
                                            </li>
                                        </ul>
                                        <label>
                                            <input type="radio" formControlName="plan" [value]="plan.id" class="sr-only"/>
                                            <span class="select-button">Select Plan</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Next Button for Step 1 -->
                        <div class="mt-8 flex justify-end">
                            <button (click)="nextStep()" [disabled]="quoteForm.invalid" class="btn-primary rounded-md px-8 py-3 font-medium">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Traveler Details -->
                    <div *ngIf="currentStep === 2" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-2 text-2xl font-semibold text-gray-900">Traveler Details</h2>
                        <p class="mb-6 text-gray-600">Please provide the primary traveler's information.</p>
                        <form [formGroup]="travelerDetailsForm">
                             <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                <div>
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Full Name<span class="text-red-500">*</span></label>
                                    <input type="text" formControlName="fullName" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                </div>
                                <div>
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Date of Birth<span class="text-red-500">*</span></label>
                                    <input type="date" formControlName="dob" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                </div>
                                <div>
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Email Address<span class="text-red-500">*</span></label>
                                    <input type="email" formControlName="email" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                </div>
                                <div>
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Phone Number<span class="text-red-500">*</span></label>
                                    <input type="tel" formControlName="phoneNumber" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" placeholder="e.g. 0712345678" />
                                </div>
                                <div>
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Number of Travelers<span class="text-red-500">*</span></label>
                                    <input type="number" formControlName="numTravelers" min="1" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                </div>
                             </div>
                             <div class="mt-6 flex items-center">
                                <input type="checkbox" formControlName="winterSports" id="winterSports" class="h-4 w-4 rounded border-gray-300 text-fidelity-turquoise focus:ring-fidelity-turquoise" />
                                <label for="winterSports" class="ml-2 text-sm text-gray-700">Add Winter Sports cover (Optional Surcharge)</label>
                            </div>
                        </form>
                    </div>

                    <!-- Step 3: Review & Pay -->
                    <div *ngIf="currentStep === 3" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-6 text-2xl font-semibold text-gray-900">Review Your Quote</h2>
                        <div class="review-section">
                            <h4>Trip Details</h4>
                            <div class="review-grid">
                                <span class="label">Plan</span><span class="value">{{ selectedPlanDetails?.name }}</span>
                                <span class="label">Cover Period</span><span class="value">{{ getDurationText(quoteForm.value.duration) }}</span>
                                <span class="label">Travelers</span><span class="value">{{ travelerDetailsForm.value.numTravelers }}</span>
                            </div>
                            <h4>Traveler Information</h4>
                            <div class="review-grid">
                                <span class="label">Name</span><span class="value">{{ travelerDetailsForm.value.fullName }}</span>
                                <span class="label">Email</span><span class="value">{{ travelerDetailsForm.value.email }}</span>
                                <span class="label">Phone</span><span class="value">{{ travelerDetailsForm.value.phoneNumber }}</span>
                            </div>
                            <h4 class="mt-8">Full Plan Benefits</h4>
                            <table *ngIf="selectedPlanDetails" class="benefit-table">
                                <thead>
                                    <tr>
                                        <th>Benefit</th>
                                        <th>Limit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container *ngFor="let benefit of selectedPlanDetails.benefits">
                                        <tr *ngIf="benefit.included">
                                            <td>{{ benefit.name }}</td>
                                            <td>{{ benefit.limit || 'Included' }}</td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Premium Summary & Navigation (HIDDEN in Step 1) -->
                <div *ngIf="currentStep > 1" class="lg:col-span-1">
                    <div class="sticky top-24 rounded-lg bg-white p-6 shadow-sm">
                        <h3 class="mb-4 text-lg font-semibold text-gray-900">Premium Summary</h3>
                        <div class="bg-fidelity-turquoise/10 space-y-3 rounded-lg p-4 text-sm">
                            <div class="flex justify-between font-semibold">
                                <span>Subtotal (USD)</span><span>$ {{ premium.subtotalUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.groupDiscountUSD > 0" class="flex justify-between text-green-600">
                                <span>Group Discount ({{ premium.groupDiscountPercentage }}%)</span>
                                <span>- $ {{ premium.groupDiscountUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.ageSurchargeUSD !== 0" class="flex justify-between" [ngClass]="{ 'text-red-500': premium.ageSurchargeUSD > 0, 'text-green-600': premium.ageSurchargeUSD < 0 }">
                                <span>Age Adjustment ({{ premium.ageAdjustmentPercentage }}%)</span>
                                <span>{{ premium.ageSurchargeUSD > 0 ? '+' : '-' }} $ {{ abs(premium.ageSurchargeUSD) | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.winterSportsSurchargeUSD > 0" class="flex justify-between text-red-500">
                                <span>Winter Sports Surcharge</span>
                                <span>+ $ {{ premium.winterSportsSurchargeUSD | number: '1.2-2' }}</span>
                            </div>
                            <div class="my-2 border-t"></div>
                            <div class="text-fidelity-turquoise flex items-center justify-between text-xl font-bold">
                                <span>Total Payable</span><span>KES {{ premium.totalPayableKES | number: '1.2-2' }}</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button *ngIf="currentStep === 2" (click)="nextStep()" [disabled]="travelerDetailsForm.invalid" class="btn-primary w-full rounded-md px-4 py-3 font-medium">Review & Save Quote</button>
                            <div *ngIf="currentStep === 3" class="mt-4 flex flex-col gap-4">
                                <button (click)="handlePayment()" class="btn-primary rounded-md px-6 py-2 font-medium">Proceed to Payment</button>
                            </div>
                             <button (click)="prevStep()" class="hover:text-fidelity-turquoise mt-2 w-full text-center text-sm font-medium text-gray-600">Back</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>