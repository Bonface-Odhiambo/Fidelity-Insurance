<!-- Backdrop for mobile sidebar -->
<div *ngIf="isMobileSidebarOpen" (click)="toggleMobileSidebar()" class="fixed inset-0 z-40 bg-black/60 lg:hidden" aria-hidden="true"></div>

<div class="flex min-h-screen w-full bg-gray-50">
  <!-- Sidebar -->
  <div class="fixed inset-y-0 left-0 z-50 flex w-64 transform flex-col text-white shadow-xl transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:flex-shrink-0" [class.translate-x-0]="isMobileSidebarOpen" [ngClass]="'sidebar-bg'">
    <div class="border-b border-white/20 p-6"><div class="flex items-center space-x-3"><div class="flex h-16 w-16 items-center justify-center rounded-xl bg-white/10 p-2"><img src="https://media.licdn.com/dms/image/v2/C4D0BAQGK4ya3Y0V4Iw/company-logo_200_200/company-logo_200_200/0/1631336758836?e=2147483647&v=beta&t=qRDfOKgxDnq46pE6Pv8nqRhBsJE-Qsz2AIfP0NssBzY" alt="Fidelity Logo" class="h-10 w-auto"/></div><div><h1 class="text-xl font-bold tracking-wide">FIDELITY</h1><p class="text-xs font-medium text-white/80">Insurance You can Trust</p></div></div></div>
    <div class="border-b border-white/20 p-6"><div class="flex items-center space-x-3"><div class="relative"><div class="flex h-12 w-12 items-center justify-center rounded-full bg-white/20 ring-2 ring-white/30"><span class="text-lg font-bold text-white">{{ getInitials(user.name) }}</span></div><div class="absolute -bottom-1 -right-1 h-4 w-4 rounded-full border-2 border-fidelity-turquoise bg-fidelity-lime"></div></div><div class="flex-1"><p class="text-sm font-medium text-white/90">Welcome back,</p><h3 class="text-lg font-bold text-white">{{ user.name.split(' ')[0] }}</h3></div></div></div>
    <nav class="flex-1 overflow-y-auto p-4"><div class="space-y-1"><ng-container *ngFor="let item of navigationItems"><a *ngIf="!item.children && item.route" [routerLink]="item.route" routerLinkActive="active-menu-item" class="nav-menu-item group flex items-center space-x-3 rounded-xl px-4 py-3 text-white/80 transition-all hover:bg-white/10 hover:text-white"><mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon><span class="font-medium">{{ item.label }}</span><span *ngIf="item.badge && item.badge > 0" class="ml-auto rounded-full bg-fidelity-lime px-2 py-1 text-xs font-bold text-fidelity-dark-text">{{ item.badge }}</span></a><div *ngIf="item.children"><button (click)="toggleNavItem(item)" class="nav-menu-item group flex w-full items-center justify-between rounded-xl px-4 py-3 text-white/80 transition-all hover:bg-white/10 hover:text-white"><div class="flex items-center space-x-3"><mat-icon class="sidebar-nav-icon">{{ item.icon }}</mat-icon><span class="font-medium">{{ item.label }}</span></div><mat-icon class="sidebar-nav-icon transition-transform duration-200" [class.rotate-180]="item.isExpanded">expand_more</mat-icon></button><div *ngIf="item.isExpanded" class="mt-1 ml-6 space-y-1"><a *ngFor="let child of item.children" [routerLink]="child.route" class="block w-full rounded-lg px-4 py-2 text-left text-sm text-white/70 transition-colors hover:bg-white/10 hover:text-white"><div class="flex items-center space-x-2"><mat-icon class="sidebar-nav-icon !text-sm">{{ child.icon }}</mat-icon><span>{{ child.label }}</span></div></a></div></div></ng-container></div></nav>
  </div>

  <!-- Main Content -->
  <div class="flex flex-1 flex-col overflow-x-hidden">
    <header class="border-b border-gray-200/50 bg-white px-4 py-3 shadow-sm sm:px-6">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center space-x-2 sm:space-x-4"><button mat-icon-button (click)="toggleMobileSidebar()" class="text-gray-600 lg:hidden"><mat-icon>menu</mat-icon></button><div><h1 class="text-xl font-bold tracking-tight text-fidelity-turquoise sm:text-2xl">Dashboard</h1><p class="mt-1 text-sm text-gray-600">Overview of your insurance portfolio</p></div></div>
            <div class="flex items-center space-x-3"><button mat-icon-button [matMenuTriggerFor]="notificationMenu" class="relative text-fidelity-turquoise"><mat-icon>notifications</mat-icon><span *ngIf="getUnreadNotificationCount() > 0" class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-fidelity-lime text-xs font-bold text-white">{{ getUnreadNotificationCount() }}</span></button><button mat-icon-button [matMenuTriggerFor]="userMenu" class="relative h-10 w-10 rounded-full bg-fidelity-turquoise text-white"><span class="text-sm font-bold">{{ getInitials(user.name) }}</span></button></div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6">
      <div class="mb-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
        <div class="stats-card" *ngFor="let stat of [{ title: 'Active Policies', value: dashboardStats.activePolicies, prefix: '' }, { title: 'Pending Quotes', value: dashboardStats.pendingQuotes, prefix: '' }, { title: 'Open Claims', value: dashboardStats.openClaims, prefix: '' }, { title: 'Total Premium', value: (dashboardStats.totalPremium | number: '1.0-0'), prefix: 'KES' }]"><h3 class="mb-2 text-sm font-semibold uppercase tracking-wide">{{ stat.title }}</h3><p class="text-3xl font-bold">{{ stat.prefix }} {{ stat.value }}</p><div class="highlight-bar"></div></div>
      </div>

      <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
        <div class="space-y-8 lg:col-span-2">
          <!-- Pending Quotes -->
          <div *ngIf="pendingQuotes.length > 0" class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg"><div class="bg-fidelity-turquoise px-6 py-4 text-white"><h3 class="flex items-center text-xl font-bold"><mat-icon class="mr-2">pending_actions</mat-icon>Quotes Awaiting Payment</h3></div><div class="p-6"><div class="grid grid-cols-1 gap-6 md:grid-cols-2"><div *ngFor="let quote of pendingQuotes" class="quote-card group rounded-xl border border-gray-200 bg-gray-50 p-6"><div class="mb-4 flex items-center justify-between"><span class="rounded-full bg-fidelity-turquoise px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white">{{ quote.type }}</span></div><h4 class="mb-2 text-lg font-bold text-fidelity-turquoise">{{ quote.title }}</h4><p class="line-clamp-2 mb-4 text-sm text-gray-600">{{ quote.description }}</p><div class="mb-6 flex items-center justify-between"><div class="text-2xl font-bold text-fidelity-turquoise">KES {{ quote.amount | number: '1.0-0' }}</div><div class="text-right"><p class="text-xs text-gray-500">Expires</p><p class="text-sm font-semibold text-gray-700">{{ quote.expiryDate | date: 'shortDate' }}</p></div></div><div class="flex space-x-3"><button mat-stroked-button (click)="editQuoteByType(quote.id, quote.type)" class="flex-1 rounded-xl !border-fidelity-turquoise px-4 py-2 text-sm font-semibold !text-fidelity-turquoise">Edit</button><button mat-raised-button (click)="initiatePayment(quote.id)" class="flex-1 rounded-xl bg-fidelity-turquoise px-4 py-2 text-sm font-semibold text-white">Pay Now</button></div></div></div></div></div>
          
          <!-- Active Policies -->
          <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg">
            <div class="bg-fidelity-lime px-6 py-4 text-fidelity-dark-text"><h2 class="flex items-center text-xl font-bold"><mat-icon class="mr-2">shield</mat-icon>Active Policies</h2></div>
            <div class="p-6"><div class="space-y-4"><div *ngFor="let policy of activePolicies" class="policy-card group overflow-hidden rounded-xl border border-gray-200"><div class="flex cursor-pointer items-center justify-between p-4" (click)="togglePolicyDetails(policy.id)"><div class="flex items-center space-x-4"><div class="flex h-12 w-12 items-center justify-center rounded-xl bg-fidelity-turquoise/10"><mat-icon class="text-fidelity-turquoise">{{ policy.type === 'marine' ? 'directions_boat' : (policy.type === 'golfers' ? 'golf_course' : 'flight') }}</mat-icon></div><div><h4 class="text-lg font-bold text-fidelity-turquoise">{{ policy.title }}</h4><p class="text-sm text-gray-600">{{ policy.policyNumber }}</p></div></div><mat-icon class="text-gray-400 transition-transform" [class.rotate-180]="expandedPolicyId === policy.id">expand_more</mat-icon></div><div class="policy-details-collapsible" [class.expanded]="expandedPolicyId === policy.id"><div class="px-6 pt-2 pb-4">
              <!-- Marine Details -->
              <div *ngIf="policy.type === 'marine' && policy.marineDetails as details"><h4 class="detail-section-title">Shipment Details</h4><div class="policy-detail-grid"><div class="detail-item"><span class="detail-label">Mode / Trade</span><span class="detail-value">{{ details.modeOfShipment | titlecase }} / {{ details.tradeType | titlecase }}</span></div><div class="detail-item"><span class="detail-label">Origin / Destination</span><span class="detail-value">{{ details.origin }} to {{ details.destination }}</span></div></div><h4 class="detail-section-title">Cargo Details</h4><div class="policy-detail-grid"><div class="detail-item"><span class="detail-label">Insured Product</span><span class="detail-value">{{ details.marineProduct }}</span></div><div class="detail-item"><span class="detail-label">Sum Insured</span><span class="detail-value">KES {{ details.sumInsured | number:'1.2-2' }}</span></div></div></div>
              <!-- Golfers Details -->
              <div *ngIf="policy.type === 'golfers' && policy.golfersDetails as details"><h4 class="detail-section-title">Assured Details</h4><div class="policy-detail-grid"><div class="detail-item"><span class="detail-label">Policy Holder</span><span class="detail-value">{{ details.fullName }}</span></div><div class="detail-item"><span class="detail-label">Home Club</span><span class="detail-value">{{ details.golfClub }}</span></div><div class="detail-item"><span class="detail-label">Cover Option</span><span class="detail-value">{{ details.coverOption }}</span></div></div></div>
              <!-- Travel Details -->
              <div *ngIf="policy.type === 'travel' && policy.travelDetails as details"><h4 class="detail-section-title">Trip Details</h4><div class="policy-detail-grid"><div class="detail-item"><span class="detail-label">Destination</span><span class="detail-value">{{ details.destination }}</span></div><div class="detail-item"><span class="detail-label">Trip Type</span><span class="detail-value">{{ details.tripType }}</span></div><div class="detail-item"><span class="detail-label">Duration</span><span class="detail-value">{{ details.duration }}</span></div></div></div>
            <div class="mt-6 flex justify-end gap-3 border-t pt-4"><button mat-stroked-button (click)="openClaimModal(policy)" class="rounded-xl !border-fidelity-turquoise !text-fidelity-turquoise">Make a Claim</button><button mat-raised-button (click)="downloadCertificate(policy.id)" class="rounded-xl bg-fidelity-turquoise text-white">Download Certificate</button></div></div></div></div></div></div>
          </div>
          
          <!-- My Claims -->
          <div *ngIf="claims.length > 0" class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg"><div class="bg-fidelity-turquoise px-6 py-4 text-white"><h3 class="flex items-center text-xl font-bold"><mat-icon class="mr-2">gavel</mat-icon>My Claims</h3></div><div class="divide-y divide-gray-200"><div *ngFor="let claim of claims" class="flex items-center justify-between p-4"><div class="flex items-center space-x-4"><div class="flex h-10 w-10 items-center justify-center rounded-lg bg-fidelity-turquoise/10"><mat-icon class="text-fidelity-turquoise">receipt_long</mat-icon></div><div><p class="font-semibold text-fidelity-dark-text">{{ claim.title }}</p><p class="text-xs text-gray-500">{{ claim.policyNumber }} &bull; Filed: {{ claim.claimDate | date:'mediumDate' }}</p></div></div><div class="rounded-full px-3 py-1 text-xs font-bold" [ngClass]="{'bg-yellow-100 text-yellow-800': claim.status === 'Pending Review', 'bg-green-100 text-green-800': claim.status === 'Approved', 'bg-red-100 text-red-800': claim.status === 'Rejected'}">{{ claim.status }}</div></div></div></div>
        
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
          <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg"><div class="bg-fidelity-lime px-6 py-4 text-fidelity-dark-text"><h3 class="text-lg font-bold">Quick Actions</h3></div><div class="space-y-4 p-6"><button mat-raised-button (click)="router.navigate(['/sign-up/marine-quote'])" class="w-full rounded-xl bg-fidelity-turquoise p-4 text-sm font-semibold text-white">New Marine Quote</button><button mat-raised-button (click)="router.navigate(['/golfers-quote'])" class="w-full rounded-xl bg-fidelity-turquoise p-4 text-sm font-semibold text-white">New Golfers Quote</button><button mat-raised-button (click)="router.navigate(['/sign-up/travel-quote'])" class="w-full rounded-xl bg-fidelity-turquoise p-4 text-sm font-semibold text-white">New Travel Quote</button></div></div>
          <div class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-lg"><div class="bg-fidelity-turquoise px-6 py-4 text-white"><h3 class="text-lg font-bold">Recent Activity</h3></div><div class="p-6"><div class="max-h-80 space-y-4 overflow-y-auto"><div *ngFor="let activity of recentActivities" class="group flex cursor-pointer items-start space-x-3 rounded-lg p-3 hover:bg-gray-50"><div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full" [style.background-color]="activity.iconColor + '20'"><mat-icon class="!text-base" [style.color]="activity.iconColor">{{ activity.icon }}</mat-icon></div><div class="min-w-0 flex-1"><p class="truncate text-sm font-semibold text-fidelity-turquoise">{{ activity.title }}</p><p class="truncate text-xs text-gray-500">{{ activity.description }}</p><p class="mt-1 text-xs text-gray-400">{{ activity.timestamp | date:'short' }}</p></div></div></div></div></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Menus -->
<mat-menu #notificationMenu="matMenu"> <div class="border-b border-gray-100 px-4 py-3"><h3 class="font-semibold text-fidelity-turquoise">Notifications</h3></div> <button mat-menu-item *ngFor="let notification of notifications" class="!min-w-[350px] !whitespace-normal px-4 py-3 hover:bg-gray-50"> <div class="flex items-start space-x-3"> <div class="mt-2 h-2 w-2 flex-shrink-0 rounded-full" [ngClass]="{'bg-fidelity-lime': !notification.read, 'bg-gray-300': notification.read}"></div> <div class="min-w-0 flex-1"> <p class="text-sm font-semibold text-fidelity-turquoise">{{ notification.title }}</p> <p class="break-words text-sm text-gray-600">{{ notification.message }}</p> <p class="mt-1 text-xs text-gray-500">{{ notification.timestamp | date:'short' }}</p> </div> </div> </button> </mat-menu>
<mat-menu #userMenu="matMenu"> <div class="border-b border-gray-100 px-4 py-3"><p class="font-semibold text-fidelity-turquoise">{{ user.name }}</p><p class="text-sm text-gray-500">{{ user.email }}</p></div> <button mat-menu-item (click)="router.navigate(['/profile'])" class="px-4 py-3 hover:bg-gray-50"><mat-icon class="mr-3 text-gray-600">person</mat-icon><span>Profile</span></button> <button mat-menu-item (click)="logout()" class="px-4 py-3 hover:bg-gray-50"><mat-icon class="mr-3 text-gray-600">logout</mat-icon><span>Logout</span></button> </mat-menu>

<!-- Integrated Claim Modal -->
<div *ngIf="showClaimModal" (click)="closeClaimModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 animate-fadeIn">
  <div (click)="$event.stopPropagation()" class="max-h-[95vh] w-full max-w-2xl overflow-y-auto rounded-2xl bg-white p-1 shadow-xl animate-scaleUp">
    <div class="p-6 sm:p-8">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-2xl font-bold text-fidelity-turquoise">Make a Claim</h2>
          <p class="mt-1 text-sm text-gray-600">Please provide the details of the incident for policy: <strong class="text-fidelity-dark-text">{{ selectedPolicyForClaim?.policyNumber }}</strong></p>
        </div>
        <button (click)="closeClaimModal()" class="text-gray-400 transition-colors hover:text-gray-700">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <form [formGroup]="claimForm" (ngSubmit)="onClaimFormSubmit()" class="mt-6 space-y-6">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Policy Number</label>
            <input type="text" formControlName="policyNumber" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2" readonly/>
          </div>
          <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Date of Loss/Incident <span class="text-red-500">*</span></label>
            <input type="date" formControlName="dateOfLoss" [max]="getToday()" class="focus-ring-primary w-full rounded-md border bg-white px-3 py-2" [ngClass]="{'border-red-500': isFieldInvalid(claimForm, 'dateOfLoss')}"/>
            <div *ngIf="isFieldInvalid(claimForm, 'dateOfLoss')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(claimForm, 'dateOfLoss') }}</div>
          </div>
        </div>

        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Estimated Loss Amount (KES) <span class="text-red-500">*</span></label>
            <input type="number" formControlName="estimatedLoss" placeholder="e.g. 50000" class="focus-ring-primary w-full rounded-md border bg-white px-3 py-2" [ngClass]="{'border-red-500': isFieldInvalid(claimForm, 'estimatedLoss')}"/>
            <div *ngIf="isFieldInvalid(claimForm, 'estimatedLoss')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(claimForm, 'estimatedLoss') }}</div>
        </div>

        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Detailed Description of Incident <span class="text-red-500">*</span></label>
            <textarea formControlName="description" rows="5" placeholder="Describe what happened, where, and what was lost or damaged. Please be as detailed as possible." class="focus-ring-primary w-full rounded-md border bg-white px-3 py-2" [ngClass]="{'border-red-500': isFieldInvalid(claimForm, 'description')}"></textarea>
            <div *ngIf="isFieldInvalid(claimForm, 'description')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(claimForm, 'description') }}</div>
        </div>

        <h4 class="border-t pt-6 text-lg font-semibold text-gray-700">Upload Documents</h4>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Police Report / Abstract <span class="text-red-500">*</span></label>
                <input type="file" formControlName="policeReport" class="focus-ring-primary block w-full cursor-pointer rounded-md border border-gray-300 text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-fidelity-turquoise/10 file:py-2 file:px-4 file:text-sm file:font-semibold file:text-fidelity-turquoise hover:file:bg-fidelity-turquoise/20" [ngClass]="{'border-red-500': isFieldInvalid(claimForm, 'policeReport')}">
                <div *ngIf="isFieldInvalid(claimForm, 'policeReport')" class="mt-1 text-sm text-red-600">{{ getErrorMessage(claimForm, 'policeReport') }}</div>
            </div>
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Other Supporting Documents</label>
                <input type="file" formControlName="supportingDocuments" multiple class="focus-ring-primary block w-full cursor-pointer rounded-md border border-gray-300 text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-fidelity-turquoise/10 file:py-2 file:px-4 file:text-sm file:font-semibold file:text-fidelity-turquoise hover:file:bg-fidelity-turquoise/20">
                <p class="mt-1 text-xs text-gray-500">Receipts, photos, invoices, etc.</p>
            </div>
        </div>

        <div class="mt-8 flex justify-end gap-4 border-t pt-6">
            <button type="button" (click)="closeClaimModal()" class="rounded-xl border border-gray-300 px-6 py-2.5 text-sm font-semibold hover:bg-gray-50">Cancel</button>
            <button type="submit" [disabled]="claimForm.invalid" class="btn-primary rounded-xl px-6 py-2.5 text-sm font-semibold">Submit Claim</button>
        </div>
      </form>
    </div>
  </div>
</div>